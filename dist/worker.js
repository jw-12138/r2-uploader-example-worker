var te=async(e,t=Object.create(null))=>{let{all:r=!1,dot:s=!1}=t,o=(e instanceof T?e.raw.headers:e.headers).get("Content-Type");return o?.startsWith("multipart/form-data")||o?.startsWith("application/x-www-form-urlencoded")?Ae(e,{all:r,dot:s}):{}};async function Ae(e,t){let r=await e.formData();return r?je(r,t):{}}function je(e,t){let r=Object.create(null);return e.forEach((s,n)=>{t.all||n.endsWith("[]")?Te(r,n,s):r[n]=s}),t.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(Se(r,s,n),delete r[s])}),r}var Te=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:e[t]=r},Se=(e,t,r)=>{let s=e,n=t.split(".");n.forEach((o,a)=>{a===n.length-1?s[o]=r:((!s[o]||typeof s[o]!="object"||Array.isArray(s[o])||s[o]instanceof File)&&(s[o]=Object.create(null)),s=s[o])})};var D=e=>{let t=e.split("/");return t[0]===""&&t.shift(),t},re=e=>{let{groups:t,path:r}=He(e),s=D(r);return _e(s,t)},He=e=>{let t=[];return e=e.replace(/\{[^}]+\}/g,(r,s)=>{let n=`@${s}`;return t.push([n,r]),n}),{groups:t,path:e}},_e=(e,t)=>{for(let r=t.length-1;r>=0;r--){let[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},S={},B=e=>{if(e==="*")return"*";let t=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return t?(S[e]||(t[2]?S[e]=[e,t[1],new RegExp("^"+t[2]+"$")]:S[e]=[e,t[1],!0]),S[e]):null},$=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},ke=e=>$(e,decodeURI),K=e=>{let t=e.url,r=t.indexOf("/",8),s=r;for(;s<t.length;s++){let n=t.charCodeAt(s);if(n===37){let o=t.indexOf("?",s),a=t.slice(r,o===-1?void 0:o);return ke(a.includes("%25")?a.replace(/%25/g,"%2525"):a)}else if(n===63)break}return t.slice(r,s)};var se=e=>{let t=K(e);return t.length>1&&t[t.length-1]==="/"?t.slice(0,-1):t},b=(...e)=>{let t="",r=!1;for(let s of e)t[t.length-1]==="/"&&(t=t.slice(0,-1),r=!0),s[0]!=="/"&&(s=`/${s}`),s==="/"&&r?t=`${t}/`:s!=="/"&&(t=`${t}${s}`),s==="/"&&t===""&&(t="/");return t},H=e=>{if(!e.match(/\:.+\?$/))return null;let t=e.split("/"),r=[],s="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);let o=n.replace("?","");s+="/"+o,r.push(s)}else s+="/"+n}),r.filter((n,o,a)=>a.indexOf(n)===o)},U=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?F(e):e):e,ne=(e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let a=e.indexOf(`?${t}`,8);for(a===-1&&(a=e.indexOf(`&${t}`,8));a!==-1;){let c=e.charCodeAt(a+t.length+1);if(c===61){let i=a+t.length+2,l=e.indexOf("&",i);return U(e.slice(i,l===-1?void 0:l))}else if(c==38||isNaN(c))return"";a=e.indexOf(`&${t}`,a+1)}if(s=/[%+]/.test(e),!s)return}let n={};s??=/[%+]/.test(e);let o=e.indexOf("?",8);for(;o!==-1;){let a=e.indexOf("&",o+1),c=e.indexOf("=",o);c>a&&a!==-1&&(c=-1);let i=e.slice(o+1,c===-1?a===-1?void 0:a:c);if(s&&(i=U(i)),o=a,i==="")continue;let l;c===-1?l="":(l=e.slice(c+1,a===-1?void 0:a),s&&(l=U(l))),r?(n[i]&&Array.isArray(n[i])||(n[i]=[]),n[i].push(l)):n[i]??=l}return t?n[t]:n},oe=ne,ie=(e,t)=>ne(e,t,!0),F=decodeURIComponent;var ae=e=>$(e,F),T=class{raw;#t;#e;routeIndex=0;path;bodyCache={};constructor(e,t="/",r=[[]]){this.raw=e,this.path=t,this.#e=r,this.#t={}}param(e){return e?this.#s(e):this.#o()}#s(e){let t=this.#e[0][this.routeIndex][1][e],r=this.#n(t);return r?/\%/.test(r)?ae(r):r:void 0}#o(){let e={},t=Object.keys(this.#e[0][this.routeIndex][1]);for(let r of t){let s=this.#n(this.#e[0][this.routeIndex][1][r]);s&&typeof s=="string"&&(e[r]=/\%/.test(s)?ae(s):s)}return e}#n(e){return this.#e[1]?this.#e[1][e]:e}query(e){return oe(this.url,e)}queries(e){return ie(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;let t={};return this.raw.headers.forEach((r,s)=>{t[s]=r}),t}async parseBody(e){return this.bodyCache.parsedBody??=await te(this,e)}#r=e=>{let{bodyCache:t,raw:r}=this,s=t[e];if(s)return s;let n=Object.keys(t)[0];return n?t[n].then(o=>(n==="json"&&(o=JSON.stringify(o)),new Response(o)[e]())):t[e]=r[e]()};json(){return this.#r("json")}text(){return this.#r("text")}arrayBuffer(){return this.#r("arrayBuffer")}blob(){return this.#r("blob")}formData(){return this.#r("formData")}addValidatedData(e,t){this.#t[e]=t}valid(e){return this.#t[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return this.#e[0].map(([[,e]])=>e)}get routePath(){return this.#e[0].map(([[,e]])=>e)[this.routeIndex].path}};var ce={Stringify:1,BeforeStream:2,Stream:3},Me=(e,t)=>{let r=new String(e);return r.isEscaped=!0,r.callbacks=t,r};var V=async(e,t,r,s,n)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));let o=e.callbacks;if(!o?.length)return Promise.resolve(e);n?n[0]+=e:n=[e];let a=Promise.all(o.map(c=>c({phase:t,buffer:n,context:s}))).then(c=>Promise.all(c.filter(Boolean).map(i=>V(i,t,!1,s,n))).then(()=>n[0]));return r?Me(await a,o):a};var qe="text/plain; charset=UTF-8",W=(e,t={})=>{for(let r of Object.keys(t))e.set(r,t[r]);return e},_=class{#t;#e;env={};#s;finalized=!1;error;#o=200;#n;#r;#i;#c;#l=!0;#f;#u;#h;#d;#p;constructor(e,t){this.#t=e,t&&(this.#n=t.executionCtx,this.env=t.env,this.#h=t.notFoundHandler,this.#p=t.path,this.#d=t.matchResult)}get req(){return this.#e??=new T(this.#t,this.#p,this.#d),this.#e}get event(){if(this.#n&&"respondWith"in this.#n)return this.#n;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#n)return this.#n;throw Error("This context has no ExecutionContext")}get res(){return this.#l=!1,this.#c||=new Response("404 Not Found",{status:404})}set res(e){if(this.#l=!1,this.#c&&e)try{for(let[t,r]of this.#c.headers.entries())if(t!=="content-type")if(t==="set-cookie"){let s=this.#c.headers.getSetCookie();e.headers.delete("set-cookie");for(let n of s)e.headers.append("set-cookie",n)}else e.headers.set(t,r)}catch(t){if(t instanceof TypeError&&t.message.includes("immutable")){this.res=new Response(e.body,{headers:e.headers,status:e.status});return}else throw t}this.#c=e,this.finalized=!0}render=(...e)=>(this.#u??=t=>this.html(t),this.#u(...e));setLayout=e=>this.#f=e;getLayout=()=>this.#f;setRenderer=e=>{this.#u=e};header=(e,t,r)=>{if(t===void 0){this.#r?this.#r.delete(e):this.#i&&delete this.#i[e.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(e);return}r?.append?(this.#r||(this.#l=!1,this.#r=new Headers(this.#i),this.#i={}),this.#r.append(e,t)):this.#r?this.#r.set(e,t):(this.#i??={},this.#i[e.toLowerCase()]=t),this.finalized&&(r?.append?this.res.headers.append(e,t):this.res.headers.set(e,t))};status=e=>{this.#l=!1,this.#o=e};set=(e,t)=>{this.#s??=new Map,this.#s.set(e,t)};get=e=>this.#s?this.#s.get(e):void 0;get var(){return this.#s?Object.fromEntries(this.#s):{}}#a(e,t,r){if(this.#l&&!r&&!t&&this.#o===200)return new Response(e,{headers:this.#i});if(t&&typeof t!="number"){let n=new Headers(t.headers);this.#r&&this.#r.forEach((a,c)=>{c==="set-cookie"?n.append(c,a):n.set(c,a)});let o=W(n,this.#i);return new Response(e,{headers:o,status:t.status??this.#o})}let s=typeof t=="number"?t:this.#o;this.#i??={},this.#r??=new Headers,W(this.#r,this.#i),this.#c&&(this.#c.headers.forEach((n,o)=>{o==="set-cookie"?this.#r?.append(o,n):this.#r?.set(o,n)}),W(this.#r,this.#i)),r??={};for(let[n,o]of Object.entries(r))if(typeof o=="string")this.#r.set(n,o);else{this.#r.delete(n);for(let a of o)this.#r.append(n,a)}return new Response(e,{status:s,headers:this.#r})}newResponse=(...e)=>this.#a(...e);body=(e,t,r)=>typeof t=="number"?this.#a(e,t,r):this.#a(e,t);text=(e,t,r)=>{if(!this.#i){if(this.#l&&!r&&!t)return new Response(e);this.#i={}}return this.#i["content-type"]=qe,typeof t=="number"?this.#a(e,t,r):this.#a(e,t)};json=(e,t,r)=>{let s=JSON.stringify(e);return this.#i??={},this.#i["content-type"]="application/json; charset=UTF-8",typeof t=="number"?this.#a(s,t,r):this.#a(s,t)};html=(e,t,r)=>(this.#i??={},this.#i["content-type"]="text/html; charset=UTF-8",typeof e=="object"?V(e,ce.Stringify,!1,{}).then(s=>typeof t=="number"?this.#a(s,t,r):this.#a(s,t)):typeof t=="number"?this.#a(e,t,r):this.#a(e,t));redirect=(e,t)=>(this.#r??=new Headers,this.#r.set("Location",String(e)),this.newResponse(null,t??302));notFound=()=>(this.#h??=()=>new Response,this.#h(this))};var G=(e,t,r)=>(s,n)=>{let o=-1,a=s instanceof _;return c(0);async function c(i){if(i<=o)throw new Error("next() called multiple times");o=i;let l,u=!1,h;if(e[i]?(h=e[i][0][0],a&&(s.req.routeIndex=i)):h=i===e.length&&n||void 0,!h)a&&s.finalized===!1&&r&&(l=await r(s));else try{l=await h(s,()=>c(i+1))}catch(d){if(d instanceof Error&&a&&t)s.error=d,l=await t(d,s),u=!0;else throw d}return l&&(s.finalized===!1||u)&&(s.res=l),s}};var p="ALL",le="all",ue=["get","post","put","delete","options","patch"],k="Can not add a route since the matcher is already built.",M=class extends Error{};var Ie=Symbol("composedHandler"),Ne=e=>e.text("404 Not Found",404),he=(e,t)=>"getResponse"in e?e.getResponse():(console.error(e),t.text("Internal Server Error",500)),z=class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#t="/";routes=[];constructor(e={}){[...ue,le].forEach(s=>{this[s]=(n,...o)=>(typeof n=="string"?this.#t=n:this.#o(s,this.#t,n),o.forEach(a=>{this.#o(s,this.#t,a)}),this)}),this.on=(s,n,...o)=>{for(let a of[n].flat()){this.#t=a;for(let c of[s].flat())o.map(i=>{this.#o(c.toUpperCase(),this.#t,i)})}return this},this.use=(s,...n)=>(typeof s=="string"?this.#t=s:(this.#t="*",n.unshift(s)),n.forEach(o=>{this.#o(p,this.#t,o)}),this);let r=e.strict??!0;delete e.strict,Object.assign(this,e),this.getPath=r?e.getPath??K:se}#e(){let e=new z({router:this.router,getPath:this.getPath});return e.routes=this.routes,e}#s=Ne;errorHandler=he;route(e,t){let r=this.basePath(e);return t.routes.map(s=>{let n;t.errorHandler===he?n=s.handler:(n=async(o,a)=>(await G([],t.errorHandler)(o,()=>s.handler(o,a))).res,n[Ie]=s.handler),r.#o(s.method,s.path,n)}),this}basePath(e){let t=this.#e();return t._basePath=b(this._basePath,e),t}onError=e=>(this.errorHandler=e,this);notFound=e=>(this.#s=e,this);mount(e,t,r){let s,n;r&&(typeof r=="function"?n=r:(n=r.optionHandler,s=r.replaceRequest));let o=n?c=>{let i=n(c);return Array.isArray(i)?i:[i]}:c=>{let i;try{i=c.executionCtx}catch{}return[c.env,i]};s||=(()=>{let c=b(this._basePath,e),i=c==="/"?0:c.length;return l=>{let u=new URL(l.url);return u.pathname=u.pathname.slice(i)||"/",new Request(u,l)}})();let a=async(c,i)=>{let l=await t(s(c.req.raw),...o(c));if(l)return l;await i()};return this.#o(p,b(e,"*"),a),this}#o(e,t,r){e=e.toUpperCase(),t=b(this._basePath,t);let s={path:t,method:e,handler:r};this.router.add(e,t,[r,s]),this.routes.push(s)}#n(e,t){if(e instanceof Error)return this.errorHandler(e,t);throw e}#r(e,t,r,s){if(s==="HEAD")return(async()=>new Response(null,await this.#r(e,t,r,"GET")))();let n=this.getPath(e,{env:r}),o=this.router.match(s,n),a=new _(e,{path:n,matchResult:o,env:r,executionCtx:t,notFoundHandler:this.#s});if(o[0].length===1){let i;try{i=o[0][0][0][0](a,async()=>{a.res=await this.#s(a)})}catch(l){return this.#n(l,a)}return i instanceof Promise?i.then(l=>l||(a.finalized?a.res:this.#s(a))).catch(l=>this.#n(l,a)):i??this.#s(a)}let c=G(o[0],this.errorHandler,this.#s);return(async()=>{try{let i=await c(a);if(!i.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return i.res}catch(i){return this.#n(i,a)}})()}fetch=(e,...t)=>this.#r(e,t[1],t[0],e.method);request=(e,t,r,s)=>e instanceof Request?this.fetch(t?new Request(e,t):e,r,s):(e=e.toString(),this.fetch(new Request(/^https?:\/\//.test(e)?e:`http://localhost${b("/",e)}`,t),r,s));fire=()=>{addEventListener("fetch",e=>{e.respondWith(this.#r(e.request,e,void 0,e.request.method))})}};var q="[^/]+",O=".*",P="(?:|/.*)",v=Symbol(),Le=new Set(".\\+*[^]$()");function Ue(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===O||e===P?1:t===O||t===P?-1:e===q?1:t===q?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var I=class{#t;#e;#s=Object.create(null);insert(e,t,r,s,n){if(e.length===0){if(this.#t!==void 0)throw v;if(n)return;this.#t=t;return}let[o,...a]=e,c=o==="*"?a.length===0?["","",O]:["","",q]:o==="/*"?["","",P]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),i;if(c){let l=c[1],u=c[2]||q;if(l&&c[2]&&(u=u.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(u)))throw v;if(i=this.#s[u],!i){if(Object.keys(this.#s).some(h=>h!==O&&h!==P))throw v;if(n)return;i=this.#s[u]=new I,l!==""&&(i.#e=s.varIndex++)}!n&&l!==""&&r.push([l,i.#e])}else if(i=this.#s[o],!i){if(Object.keys(this.#s).some(l=>l.length>1&&l!==O&&l!==P))throw v;if(n)return;i=this.#s[o]=new I}i.insert(a,t,r,s,n)}buildRegExpStr(){let t=Object.keys(this.#s).sort(Ue).map(r=>{let s=this.#s[r];return(typeof s.#e=="number"?`(${r})@${s.#e}`:Le.has(r)?`\\${r}`:r)+s.buildRegExpStr()});return typeof this.#t=="number"&&t.unshift(`#${this.#t}`),t.length===0?"":t.length===1?t[0]:"(?:"+t.join("|")+")"}};var fe=class{#t={varIndex:0};#e=new I;insert(e,t,r){let s=[],n=[];for(let a=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,i=>{let l=`@\\${a}`;return n[a]=[l,i],a++,c=!0,l}),!c)break}let o=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let a=n.length-1;a>=0;a--){let[c]=n[a];for(let i=o.length-1;i>=0;i--)if(o[i].indexOf(c)!==-1){o[i]=o[i].replace(c,n[a][1]);break}}return this.#e.insert(o,t,s,this.#t,r),s}buildRegExp(){let e=this.#e.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0,r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,o,a)=>o!==void 0?(r[++t]=Number(o),"$()"):(a!==void 0&&(s[Number(a)]=++t),"")),[new RegExp(`^${e}`),r,s]}};var de=[],De=[/^$/,[],Object.create(null)],pe=Object.create(null);function me(e){return pe[e]??=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`)}function Be(){pe=Object.create(null)}function $e(e){let t=new fe,r=[];if(e.length===0)return De;let s=e.map(l=>[!/\*|\/:/.test(l[0]),...l]).sort(([l,u],[h,d])=>l?1:h?-1:u.length-d.length),n=Object.create(null);for(let l=0,u=-1,h=s.length;l<h;l++){let[d,f,y]=s[l];d?n[f]=[y.map(([x])=>[x,Object.create(null)]),de]:u++;let g;try{g=t.insert(f,u,d)}catch(x){throw x===v?new M(f):x}d||(r[u]=y.map(([x,E])=>{let w=Object.create(null);for(E-=1;E>=0;E--){let[N,A]=g[E];w[N]=A}return[x,w]}))}let[o,a,c]=t.buildRegExp();for(let l=0,u=r.length;l<u;l++)for(let h=0,d=r[l].length;h<d;h++){let f=r[l][h]?.[1];if(!f)continue;let y=Object.keys(f);for(let g=0,x=y.length;g<x;g++)f[y[g]]=c[f[y[g]]]}let i=[];for(let l in a)i[l]=r[a[l]];return[o,i,n]}function C(e,t){if(e){for(let r of Object.keys(e).sort((s,n)=>n.length-s.length))if(me(r).test(t))return[...e[r]]}}var Y=class{name="RegExpRouter";#t;#e;constructor(){this.#t={[p]:Object.create(null)},this.#e={[p]:Object.create(null)}}add(e,t,r){let s=this.#t,n=this.#e;if(!s||!n)throw new Error(k);s[e]||[s,n].forEach(c=>{c[e]=Object.create(null),Object.keys(c[p]).forEach(i=>{c[e][i]=[...c[p][i]]})}),t==="/*"&&(t="*");let o=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){let c=me(t);e===p?Object.keys(s).forEach(i=>{s[i][t]||=C(s[i],t)||C(s[p],t)||[]}):s[e][t]||=C(s[e],t)||C(s[p],t)||[],Object.keys(s).forEach(i=>{(e===p||e===i)&&Object.keys(s[i]).forEach(l=>{c.test(l)&&s[i][l].push([r,o])})}),Object.keys(n).forEach(i=>{(e===p||e===i)&&Object.keys(n[i]).forEach(l=>c.test(l)&&n[i][l].push([r,o]))});return}let a=H(t)||[t];for(let c=0,i=a.length;c<i;c++){let l=a[c];Object.keys(n).forEach(u=>{(e===p||e===u)&&(n[u][l]||=[...C(s[u],l)||C(s[p],l)||[]],n[u][l].push([r,o-i+c+1]))})}}match(e,t){Be();let r=this.#s();return this.match=(s,n)=>{let o=r[s]||r[p],a=o[2][n];if(a)return a;let c=n.match(o[0]);if(!c)return[[],de];let i=c.indexOf("",1);return[o[1][i],c]},this.match(e,t)}#s(){let e=Object.create(null);return Object.keys(this.#e).concat(Object.keys(this.#t)).forEach(t=>{e[t]||=this.#o(t)}),this.#t=this.#e=void 0,e}#o(e){let t=[],r=e===p;return[this.#t,this.#e].forEach(s=>{let n=s[e]?Object.keys(s[e]).map(o=>[o,s[e][o]]):[];n.length!==0?(r||=!0,t.push(...n)):e!==p&&t.push(...Object.keys(s[p]).map(o=>[o,s[p][o]]))}),r?$e(t):null}};var Q=class{name="SmartRouter";#t=[];#e=[];constructor(e){this.#t=e.routers}add(e,t,r){if(!this.#e)throw new Error(k);this.#e.push([e,t,r])}match(e,t){if(!this.#e)throw new Error("Fatal error");let r=this.#t,s=this.#e,n=r.length,o=0,a;for(;o<n;o++){let c=r[o];try{for(let i=0,l=s.length;i<l;i++)c.add(...s[i]);a=c.match(e,t)}catch(i){if(i instanceof M)continue;throw i}this.match=c.match.bind(c),this.#t=[c],this.#e=void 0;break}if(o===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,a}get activeRouter(){if(this.#e||this.#t.length!==1)throw new Error("No active router has been determined yet.");return this.#t[0]}};var X=class{#t;#e;#s;#o=0;#n=Object.create(null);constructor(e,t,r){if(this.#e=r||Object.create(null),this.#t=[],e&&t){let s=Object.create(null);s[e]={handler:t,possibleKeys:[],score:0},this.#t=[s]}this.#s=[]}insert(e,t,r){this.#o=++this.#o;let s=this,n=re(t),o=[];for(let i=0,l=n.length;i<l;i++){let u=n[i];if(Object.keys(s.#e).includes(u)){s=s.#e[u];let d=B(u);d&&o.push(d[1]);continue}s.#e[u]=new X;let h=B(u);h&&(s.#s.push(h),o.push(h[1])),s=s.#e[u]}let a=Object.create(null),c={handler:r,possibleKeys:o.filter((i,l,u)=>u.indexOf(i)===l),score:this.#o};return a[e]=c,s.#t.push(a),s}#r(e,t,r,s){let n=[];for(let o=0,a=e.#t.length;o<a;o++){let c=e.#t[o],i=c[t]||c[p],l={};if(i!==void 0){i.params=Object.create(null);for(let u=0,h=i.possibleKeys.length;u<h;u++){let d=i.possibleKeys[u],f=l[i.score];i.params[d]=s[d]&&!f?s[d]:r[d]??s[d],l[i.score]=!0}n.push(i)}}return n}search(e,t){let r=[];this.#n=Object.create(null);let n=[this],o=D(t);for(let a=0,c=o.length;a<c;a++){let i=o[a],l=a===c-1,u=[];for(let h=0,d=n.length;h<d;h++){let f=n[h],y=f.#e[i];y&&(y.#n=f.#n,l?(y.#e["*"]&&r.push(...this.#r(y.#e["*"],e,f.#n,Object.create(null))),r.push(...this.#r(y,e,f.#n,Object.create(null)))):u.push(y));for(let g=0,x=f.#s.length;g<x;g++){let E=f.#s[g],w={...f.#n};if(E==="*"){let L=f.#e["*"];L&&(r.push(...this.#r(L,e,f.#n,Object.create(null))),u.push(L));continue}if(i==="")continue;let[N,A,j]=E,R=f.#e[N],ee=o.slice(a).join("/");if(j instanceof RegExp&&j.test(ee)){w[A]=ee,r.push(...this.#r(R,e,f.#n,w));continue}(j===!0||j.test(i))&&(w[A]=i,l?(r.push(...this.#r(R,e,w,f.#n)),R.#e["*"]&&r.push(...this.#r(R.#e["*"],e,w,f.#n))):(R.#n=w,u.push(R)))}}n=u}return r.length>1&&r.sort((a,c)=>a.score-c.score),[r.map(({handler:a,params:c})=>[a,c])]}};var J=class{name="TrieRouter";#t;constructor(){this.#t=new X}add(e,t,r){let s=H(t);if(s){for(let n=0,o=s.length;n<o;n++)this.#t.insert(e,s[n],r);return}this.#t.insert(e,t,r)}match(e,t){return this.#t.search(e,t)}};var Z=class extends z{constructor(e={}){super(e),this.router=e.router??new Q({routers:[new Y,new J]})}};var ye=e=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},s=(n=>typeof n=="string"?n==="*"?()=>n:o=>n===o?o:null:typeof n=="function"?n:o=>n.includes(o)?o:null)(r.origin);return async function(o,a){function c(l,u){o.res.headers.set(l,u)}let i=s(o.req.header("origin")||"",o);if(i&&c("Access-Control-Allow-Origin",i),r.origin!=="*"){let l=o.req.header("Vary");l?c("Vary",l):c("Vary","Origin")}if(r.credentials&&c("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&c("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),o.req.method==="OPTIONS"){r.maxAge!=null&&c("Access-Control-Max-Age",r.maxAge.toString()),r.allowMethods?.length&&c("Access-Control-Allow-Methods",r.allowMethods.join(","));let l=r.allowHeaders;if(!l?.length){let u=o.req.header("Access-Control-Request-Headers");u&&(l=u.split(/\s*,\s*/))}return l?.length&&(c("Access-Control-Allow-Headers",l.join(",")),o.res.headers.append("Vary","Access-Control-Request-Headers")),o.res.headers.delete("Content-Length"),o.res.headers.delete("Content-Type"),new Response(null,{headers:o.res.headers,status:204,statusText:o.res.statusText})}await a()}};async function ge(e){let t=e.req.param("key"),r=await e.env.R2_BUCKET.get(t);if(r===null)return new Response("Object Not Found",{status:404});let s=new Headers;return r.writeHttpMetadata(s),s.set("etag",r.httpEtag),s.set("Access-Control-Allow-Origin","*"),new Response(r.body,{headers:s})}async function xe(e){let t=e.req.query("cursor"),r=await e.env.R2_BUCKET.list({cursor:t||void 0});return e.json(r)}async function we(e){let t=e.req.param("key"),r=await e.req.blob(),s=e.env.R2_BUCKET;return t?(await s.put(t,r,{httpMetadata:{contentType:r.type}}),e.text("Done")):e.text("file name is required",400)}async function Ee(e){let t=e.req.param("key");return await e.env.R2_BUCKET.delete(t),new Response(null,{status:204})}async function Re(e){let t=e.req.param("key"),r=await e.env.R2_BUCKET.createMultipartUpload(t);return e.json({key:r.key,uploadId:r.uploadId})}async function be(e){let t=e.req.query("uploadId"),r=e.req.query("partNumber")||"",s=e.req.param("key");if(!t)return e.text("uploadId is required",400);if(!r)return e.text("partNumber is required",400);let n=Number(r);if(isNaN(n))return e.text("partNumber must be a number",400);let o=e.env.R2_BUCKET.resumeMultipartUpload(s,t);try{let a=await o.uploadPart(n,e.req.raw.body);return new Response(JSON.stringify(a))}catch(a){return new Response(a.message,{status:400})}}async function ve(e){let t=e.req.param("key"),r=e.req.query("uploadId");if(!r)return e.text("uploadId is required",400);let s=e.env.R2_BUCKET.resumeMultipartUpload(t,r);try{await s.abort()}catch(n){return new Response(n.message,{status:400})}return new Response(null,{status:204})}async function Ce(e){let t=e.req.param("key"),r=e.req.query("uploadId");if(!r)return e.text("uploadId is required",400);let s=e.env.R2_BUCKET.resumeMultipartUpload(t,r),n;try{n=await e.req.json()}catch(o){return console.log("parsing complete body failed"),console.log(o),e.text("invalid json",400)}try{let o=await s.complete(n.parts);return new Response(null,{headers:{etag:o.httpEtag}})}catch(o){return new Response(o.message,{status:400})}}function Oe(e){return e.text("yes")}function Ke(e){if(!e.env.AUTH_KEY_SECRET)return e.text("AUTH_KEY_SECRET is not set",403);let t=e.req.header("x-api-key")===e.env.AUTH_KEY_SECRET;return e.req.method==="GET"?e.env.PRIVATE_BUCKET?t:!0:["POST","PATCH","PUT","DELETE"].includes(e.req.method)?t:e.req.method==="OPTIONS"}async function Pe(e,t){return Ke(e)&&(console.log("Header is valid"),await t()),e.json({status:401,message:"Unauthorized"})}var m=new Z;m.use("*",Pe);m.use(ye());m.get("/",e=>e.text("Hello R2! v2024.11.28"));m.get("/support_mpu",Oe);m.post("/mpu/create/:key{.*}",Re);m.put("/mpu/:key{.*}",be);m.delete("/mpu/:key{.*}",ve);m.post("/mpu/complete/:key{.*}",Ce);m.get("/:key{.*}",ge);m.patch("/",xe);m.put("/:key{.*}",we);m.delete("/:key{.*}",Ee);m.all("*",e=>e.text("404 Not Found"));var gr=m;export{gr as default};
//# sourceMappingURL=index.js.map
